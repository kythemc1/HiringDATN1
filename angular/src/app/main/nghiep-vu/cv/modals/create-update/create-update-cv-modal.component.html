<div class="cv-builder-container" *ngIf="inline">
  <div class="cv-workspace">
    
    <aside class="cv-editor">
      <header class="editor-header">
        <h2>Thiết kế CV chuyên nghiệp</h2>
        <div class="actions-top gap-2">
          <vt-button [label]="'Hủy'" [outline]="true" (buttonClick)="close()"></vt-button>
          <vt-button 
            [label]="'Xuất PDF'" 
            [color]="'primary'" 
            (buttonClick)="exportToPDF()"
            class="ml-2">
            <i class="pi pi-file-pdf"></i>
        </vt-button>
          <vt-button *ngIf="!readOnly" [label]="'Lưu CV'" [color]="'custom'" (buttonClick)="save()"></vt-button>
        </div>
      </header>

      <form [formGroup]="form" class="editor-forms">
        <div formGroupName="createUpdateCandidateProfileDto">
          <app-toggleable-card title="1. Thông tin cá nhân" [isExpanded]="true">
            <div class="row g-3 p-3">
              <div class="col-12"><label>Họ và tên</label><input pInputText formControlName="fullName" class="w-100" /></div>
              <div class="col-12"><label>Vị trí ứng tuyển</label><input pInputText formControlName="jobTitle" class="w-100" /></div>
              <div class="col-6"><label>Email</label><input pInputText formControlName="email" class="w-100" /></div>
              <div class="col-6"><label>Số điện thoại</label><input pInputText formControlName="phoneNumber" class="w-100" /></div>
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label class="m-0">Mục tiêu nghề nghiệp</label>
                  <button type="button" class="ai-btn" (click)="onGenerateCareerObjective()"><i class="pi pi-sparkles"></i> AI Viết hộ</button>
                </div>
                <textarea pInputTextarea rows="3" formControlName="aboutMe" class="w-100"></textarea>
              </div>
            </div>
          </app-toggleable-card>
        </div>

        <app-toggleable-card title="2. Kinh nghiệm làm việc" class="mt-3">
          <div formArrayName="createUpdateCandidateExperienceDtos" class="p-3">
            <div *ngFor="let exp of candidateExperienceForms.controls; let i = index" [formGroupName]="i" class="dynamic-item">
              <div class="row g-2">
                <div class="col-6"><input pInputText placeholder="Công ty" formControlName="companyName" class="w-100" /></div>
                <div class="col-6"><input pInputText placeholder="Vị trí" formControlName="position" class="w-100" /></div>
                <div class="col-12">
                  <button type="button" class="ai-btn mini mb-1" (click)="onOptimizeWorkExperience(i)"><i class="pi pi-bolt"></i> Tối ưu mô tả AI</button>
                  <textarea pInputTextarea rows="2" formControlName="description" placeholder="Mô tả thành tựu..." class="w-100"></textarea>
                </div>
              </div>
              <button type="button" class="remove-item" (click)="removeExperience(i)"><i class="pi pi-times"></i></button>
            </div>
            <button type="button" class="add-btn" (click)="addExperience()"><i class="pi pi-plus"></i> Thêm kinh nghiệm</button>
          </div>
        </app-toggleable-card>

        <app-toggleable-card title="3. Dự án tiêu biểu" class="mt-3">
          <div formArrayName="createUpdateCandidateProjectDtos" class="p-3">
            <div *ngFor="let proj of candidateProjectForms.controls; let i = index" [formGroupName]="i" class="dynamic-item">
              <div class="row g-2">
                <div class="col-8"><input pInputText placeholder="Tên dự án" formControlName="name" class="w-100" /></div>
                <div class="col-4"><input pInputText placeholder="Size" type="number" formControlName="teamSize" class="w-100" /></div>
                <div class="col-12"><input pInputText placeholder="Công nghệ (Java, Angular...)" formControlName="technologies" class="w-100" /></div>
                <div class="col-12"><textarea pInputTextarea rows="2" placeholder="Mô tả dự án & vai trò" formControlName="description" class="w-100"></textarea></div>
              </div>
              <button type="button" class="remove-item" (click)="removeProject(i)"><i class="pi pi-times"></i></button>
            </div>
            <button type="button" class="add-btn" (click)="addProject()"><i class="pi pi-plus"></i> Thêm dự án</button>
          </div>
        </app-toggleable-card>

        <app-toggleable-card title="4. Kỹ năng chuyên môn" class="mt-3">
          <div formArrayName="createUpdateCandidateSkillDtos" class="p-3">
            <div class="skill-grid">
              <div *ngFor="let skill of candidateSkillForms.controls; let i = index" [formGroupName]="i" class="skill-item">
                <input pInputText placeholder="Kỹ năng" formControlName="skillDefinitionId" />
                <input pInputText placeholder="Level" formControlName="level" style="width: 80px" />
                <button type="button" (click)="removeSkill(i)" class="btn-icon text-danger"><i class="pi pi-trash"></i></button>
              </div>
            </div>
            <button type="button" class="add-btn mt-2" (click)="addSkill()"><i class="pi pi-plus"></i> Thêm kỹ năng</button>
          </div>
        </app-toggleable-card>

        <app-toggleable-card title="5. Học vấn & Chứng chỉ" class="mt-3">
          <div class="p-3">
             <h6>Học vấn</h6>
             <div formArrayName="createUpdateCandidateEducationDtos">
                <div *ngFor="let edu of candidateEducationForms.controls; let i = index" [formGroupName]="i" class="dynamic-item mb-2">
                  <input pInputText placeholder="Trường học" formControlName="schoolName" class="w-100 mb-1" />
                  <div class="row g-2">
                    <div class="col-6"><input pInputText placeholder="Bằng cấp" formControlName="degree" class="w-100" /></div>
                    <div class="col-6"><input pInputText placeholder="GPA" formControlName="gpa" class="w-100" /></div>
                  </div>
                  <button type="button" class="remove-item" (click)="removeEducation(i)"><i class="pi pi-times"></i></button>
                </div>
             </div>
             <button type="button" class="add-btn mini" (click)="addEducation()">+ Thêm học vấn</button>

             <h6 class="mt-3">Chứng chỉ</h6>
             <div formArrayName="createUpdateCandidateCertificateDtos">
                <div *ngFor="let cert of candidateCertificateForms.controls; let i = index" [formGroupName]="i" class="dynamic-item mb-2">
                  <input pInputText placeholder="Tên chứng chỉ" formControlName="name" class="w-100" />
                  <button type="button" class="remove-item" (click)="removeCertificate(i)"><i class="pi pi-times"></i></button>
                </div>
             </div>
             <button type="button" class="add-btn mini" (click)="addCertificate()">+ Thêm chứng chỉ</button>
          </div>
        </app-toggleable-card>
      </form>
    </aside>

    <main class="cv-preview-area" >
      <div class="a4-sheet shadow-2" id="cvPreview">
        <div class="cv-content-preview" *ngIf="form.value as formValue">
          
          <div class="cv-header-p">
            <h1>{{ formValue.createUpdateCandidateProfileDto?.fullName || 'HỌ TÊN ỨNG VIÊN' }}</h1>
            <p class="job-title-p">{{ formValue.createUpdateCandidateProfileDto?.jobTitle || 'Vị trí công việc' }}</p>
            <div class="contact-p">
              <span *ngIf="formValue.createUpdateCandidateProfileDto?.email"><i class="pi pi-envelope"></i> {{ formValue.createUpdateCandidateProfileDto.email }}</span>
              <span *ngIf="formValue.createUpdateCandidateProfileDto?.phoneNumber"><i class="pi pi-phone"></i> {{ formValue.createUpdateCandidateProfileDto.phoneNumber }}</span>
            </div>
          </div>

          <div class="cv-body-p">
            <div class="left-col-p">
              <section *ngIf="formValue.createUpdateCandidateSkillDtos?.length">
                <h5 class="sect-title">KỸ NĂNG</h5>
                <ul class="skill-list-p">
                  <li *ngFor="let s of formValue.createUpdateCandidateSkillDtos">
                    {{ s.skillDefinitionId }} <small *ngIf="s.level">({{ s.level }})</small>
                  </li>
                </ul>
              </section>

              <section *ngIf="formValue.createUpdateCandidateCertificateDtos?.length" class="mt-4">
                <h5 class="sect-title">CHỨNG CHỈ</h5>
                <div *ngFor="let cert of formValue.createUpdateCandidateCertificateDtos" class="small mb-2">
                  • {{ cert.name }}
                </div>
              </section>
            </div>

            <div class="right-col-p">
              <section class="mb-4" *ngIf="formValue.createUpdateCandidateProfileDto?.aboutMe">
                <h5 class="sect-title">TÓM TẮT</h5>
                <p class="content-text">{{ formValue.createUpdateCandidateProfileDto.aboutMe }}</p>
              </section>
              
              <section class="mb-4" *ngIf="formValue.createUpdateCandidateExperienceDtos?.length">
                <h5 class="sect-title">KINH NGHIỆM</h5>
                <div *ngFor="let ex of formValue.createUpdateCandidateExperienceDtos" class="mb-3">
                  <div class="d-flex justify-content-between">
                    <strong>{{ ex.position }}</strong>
                    <em class="small">{{ ex.companyName }}</em>
                  </div>
                  <p class="small text-muted mb-0 white-space-pre">{{ ex.description }}</p>
                </div>
              </section>

              <section class="mb-4" *ngIf="formValue.createUpdateCandidateEducationDtos?.length">
                <h5 class="sect-title">HỌC VẤN</h5>
                <div *ngFor="let edu of formValue.createUpdateCandidateEducationDtos" class="mb-2">
                  <div class="d-flex justify-content-between">
                    <strong>{{ edu.schoolName }}</strong>
                    <span class="small" *ngIf="edu.gpa">GPA: {{ edu.gpa }}</span>
                  </div>
                  <div class="small">{{ edu.degree }}</div>
                </div>
              </section>

              <section *ngIf="formValue.createUpdateCandidateProjectDtos?.length">
                <h5 class="sect-title">DỰ ÁN</h5>
                <div *ngFor="let pj of formValue.createUpdateCandidateProjectDtos" class="mb-3">
                  <div class="d-flex justify-content-between">
                    <strong>{{ pj.name }}</strong>
                    <span class="small">({{ pj.teamSize }} thành viên)</span>
                  </div>
                  <div class="small text-primary mb-1">Tech: {{ pj.technologies }}</div>
                  <p class="small mb-0">{{ pj.description }}</p>
                </div>
              </section>
            </div>
          </div>

        </div>
      </div>
    </main>

  </div>
</div>
